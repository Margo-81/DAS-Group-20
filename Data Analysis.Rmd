---
title: "Data Analysis"
author: "Group20"
documentclass: article
output:
  pdf_document: 
    number_sections: yes
    fig_width: 15
    fig_height: 15
    fig_caption: yes
    fig_crop: no
  word_document: default
geometry: left=2cm,right=2cm,top=2cm,bottom=2cm
header-includes:
  - \usepackage{float}
---

------------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA)
```

```{r libraries, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
library(ggplot2)
library(dplyr) 
library(moderndive) 
library(gapminder) 
library(skimr) 
library(tidyverse)
library(gridExtra)
library(GGally)
library(formatR)
library(qcc)
library(car)
library(MASS)
library(scales)
```
# Introduction {#sec:intro}
comment here...

# Load Data {#sec:load}
```{r loaddata, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE}
dataset20 <- read.csv("dataset20.csv")
library(knitr)
dataset20$animal_type<-as.factor(dataset20$animal_type)
dataset20$intake_type<-as.factor(dataset20$intake_type)
dataset20$outcome_type<-as.factor(dataset20$outcome_type)
dataset20$chip_status<-as.factor(dataset20$chip_status)
dataset20$month<-as.factor(dataset20$month)
head20<-head(dataset20)#View the structure of data
library(kableExtra)
head20 %>%
  kable(caption = '\\label{tab:summary} Summary statistics on Dallas animal shelter.', align = 'c') %>%
  kable_styling(latex_option = "hold_position")
```
# Exploratory Data Analysis {#sec:exploratory}

```{r exploratory1, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE,fig.align = "center",fig.dim=c(13,8), fig.pos = "H",fig.cap = "\\label{fig:histgram} Days stay at shelter"}
dataset20 %>%
  ggplot(aes(x = time_at_shelter)) +
  geom_histogram(binwidth = 5,fill="deep pink",color="white") +
  labs(x = "Time at shelter", y = "Number of days")
```

comment here...

```{r exploratory2, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE,fig.align = "center",fig.dim=c(13,8), fig.pos = "H",fig.cap = "\\label{fig:animal} Different time at shelter of different categorical variables"}

#Plot pie charts of 4 categorical variables
animal_count <- dataset20 %>% 
  group_by(animal_type) %>% 
  summarize(count = n())

total_count1 <- sum(animal_count$count)
animal_count$percent1 <- animal_count$count/ total_count1
pie1<-ggplot(animal_count, aes(x = "animal_type", y = percent1,fill =animal_type)) +
  geom_col(width = 1) + coord_polar(theta = "y") + 
  geom_text(aes(label=paste0(round(percent1*100),"%")),position=position_stack(vjust=0.5)) +theme_void() + 
  ggtitle("Pie chart of animal type")

outcome_count <- dataset20 %>% 
  group_by(outcome_type) %>% 
  summarize(count = n())

total_count2 <- sum(outcome_count$count)
outcome_count$percent2<- outcome_count$count/ total_count2

pie2<-ggplot(outcome_count, aes(x = "outcome_type",y = percent2,fill =outcome_type)) + 
geom_col(width = 1) + coord_polar(theta = "y") + 
  geom_text(aes(label=paste0(round(percent2*100),"%")),position=position_stack(vjust=0.5)) +
  theme_void() + 
  ggtitle("Pie chart of outcome type")

chip_count <- dataset20 %>% 
  group_by(chip_status) %>% 
  summarize(count = n())

total_count3 <- sum(chip_count$count)
chip_count$percent3<- chip_count$count/total_count3

pie3<-ggplot(chip_count, aes(x = "chip_status",y = percent3,fill =chip_status))+ 
geom_col(width = 1) + 
  coord_polar(theta = "y") + 
  geom_text(aes(label=paste0(round(percent3*100),"%")),position=position_stack(vjust=0.5))+
  theme_void() + 
  ggtitle("Pie chart of chip status")

intake_count <- dataset20 %>% 
  group_by(intake_type) %>% 
  summarize(count = n())

total_count4 <- sum(intake_count$count)

intake_count$percent4<- intake_count$count/total_count4

pie4<-ggplot(intake_count, aes(x = "intake_type",y = percent4,fill =intake_type)) + 
  geom_col(width = 1) + 
  coord_polar(theta = "y") + 
  geom_text(aes(label=paste0(round(percent4*100),"%")),position=position_stack(vjust=0.5))+theme_void() + 
  ggtitle("Pie chart of intake type")

grid.arrange(pie1,pie2,pie3,pie4,ncol=2,nrow=2)
```

```{r exploratory3, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE,fig.align = "center",fig.dim=c(13,8), fig.pos = "H",fig.cap = "\\label{fig:animal} Boxplots of different time at shelter of different categorical variables"}
#Create 4 box plots of categorical variables and "time_at_shelter" 
#with color mapped to categorical variables
plot1<-ggplot(data =dataset20, aes(x=animal_type, y=time_at_shelter, fill=animal_type)) +
  geom_boxplot() +
  labs(x = "Animal type", y = "Time at shelter")+ 
  theme(legend.position = "none")
plot2<-ggplot(data =dataset20, aes(x=outcome_type, y=time_at_shelter, fill=outcome_type)) +
  geom_boxplot() +
  labs(x = "Outcome type", y = "Time at shelter")+ 
  theme(legend.position = "none")
plot3<-ggplot(data =dataset20, aes(x=chip_status, y=time_at_shelter, fill=chip_status)) +
  geom_boxplot() +
  labs(x = "Chip status", y = "Time at shelter")+ 
  theme(legend.position = "none")
plot4<-ggplot(data =dataset20, aes(x=intake_type, y=time_at_shelter, fill=intake_type)) +
  geom_boxplot() +
  labs(x = "Intake type", y = "Time at shelter")+ 
  theme(legend.position = "none")
library(gridExtra)
grid.arrange(plot1,plot2,plot3,plot4,ncol=2,nrow=2)
```

comment here...

```{r exploratory5, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE,fig.align = "center",fig.dim=c(13,8), fig.pos = "H",fig.cap = "\\label{fig:month} Boxplots of time at shelter by month"}
ggplot(data = dataset20, mapping = aes(x = factor(month), y = time_at_shelter)) +
  geom_boxplot(fill = "purple") +
  labs(x = "Month", y = "time_at_shelter",
       title = "Boxplots of time at shelter by month")  +
  scale_x_discrete(labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                              "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
```

From the figure \ref{fig:month}, comment here...

# Application Condition Judgement {#sec:check}
## Check of outliers {#sec:outliers}
```{r outliercheck, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE,fig.align = "center",fig.dim=c(13,8), fig.pos = "H",fig.cap = "\\label{fig:boxplot} Boxplot of number of days at shelter to check for outliers"}
# detection of outliers
boxplot(dataset20$time_at_shelter,
        col=c('orange'),
        ylab="Days",xlab="Time at shelter")
```

The figure \ref{fig:boxplot} indicates multiple outliers, by looking at the maximum values which is 87 which means that the days the animal spent at the shelter was 87. In this case, the 'outliers' we find are consistent with the actual conditions, thus these values can be retained.

## Check of Overdispersion {#sec:overdispersion}
```{r overdispersion_check, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE,fig.align = "center",fig.dim=c(13,8), fig.pos = "H",fig.cap = "\\label{fig:overdispersion} Scatterplot of overdispersion detection"}
fit1<-glm(time_at_shelter~animal_type+intake_type+outcome_type+chip_status+month,
          data=dataset20,family=poisson(link = "log")) #build poisson glm model
summary(fit1) #view the coefficients
c<-deviance(fit1)/df.residual(fit1) #calculate the deviance over the degree of residual
c 
ggplot(fit1,aes(x=log(fitted(fit1)),y=log((dataset20$time_at_shelter-fitted(fit1))^2)))+
  geom_point(col="#f46d43") + 
  geom_abline(slope=1, intercept=0, col="#a6d96a", size=1) + 
  ylab(expression((y-hat(mu))^2)) + xlab(expression(hat(mu)))
```

comment here(about the summary)...

The proportion is much greater than 1 From the figure \ref{fig:overdispersion}, this appears that most of the points lie above the line of quality for mean and variance. These both imply that may have overdispersion of the data. Then use the qcc library to test whether the data is overdispersion.

```{r overdispersion_check2, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE}
qcc.overdispersion.test(dataset20$time_at_shelter,type="poisson")
```

The p-value of significance testing is less than 0.05, further indicating overdispersion in data.

## Check of Multicollinearity {#sec:Multicollinearity}
```{r multicollinearty_check, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE}
fit2<- lm(time_at_shelter~animal_type+intake_type+outcome_type+chip_status+month,
          data=dataset20) #build the linear model
vif(fit2) %>% #calculate VIF
  kable(caption = '\\label{tab:vif} Variance Inflation Factor table', align = 'c') %>%
  kable_styling(latex_option = "hold_position")
```

From the above table, it lists the VIF of the independent variables. It indicates that the VIF of the variables are all less than 10 which means that the independent variables doesn't exist serious multicollinearity.

# Model fitting {#sec:fitting}
We fit a negative binomial model here:
```{r negativebinomial, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE}
fit3<- glm.nb(time_at_shelter~animal_type+intake_type+outcome_type+chip_status+month,
               data = dataset20)
summary(fit3)
```

To decide between the quasi-Poisson and the negative binomial model, we plot $(y_{\mbox{i}}-\widehat{\mu}_{\mbox{i}})^2$ v $\widehat{\mu}_{\mbox{i}}$ and compare the linear and quadratic fit to see which one of them fits better. 

In the original quasi-Poisson model, we detected that only the $p$-value for  the month8 is significant (<0.05), hence, we removed the covariate of the month from the model.

```{r modelselection, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE}
fit4<- glm.nb(time_at_shelter~animal_type+intake_type+outcome_type+chip_status,
               data = dataset20)
summary(fit4)
```

The $p$-values for  the chip_status are not significant (<0.05), therefore, we removed the covariate of the chip_status from the model.

```{r modelselection2, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE}
fit5<- glm.nb(time_at_shelter~animal_type+intake_type+outcome_type,
               data = dataset20)
summary(fit5)
```

comment...

# Conclusion {#sec:conclusion}
